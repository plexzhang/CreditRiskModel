{"name":"Credit Risk Model for an Anonymous Company","tagline":"build predictive models to calculate the probability of the credit risk and choose cut-off rate for default risk to provide decision support on profit-risk control","body":"# Credit Risk Model for an Anonymous Company\r\nShiming Zhou  \r\nNovember 29, 2014  \r\n\r\n## Executive Summary\r\n1. **Purpose**: Use dataset(including 7 predictors) as the input variables. Built the predictive model give the probability of the default risk.\r\n2. **Preprocessing step**: Explored the missing values; Center-scale, and boxcox the skewed numeric predictors; Created dummy variables for factor predictors; Remove redundant highly correlated variables; Remove near-zero predictors to form reducedset, but also keep the near-zero as well as the full set (can be used for differen models).\r\n3. **Measure the performance**: Build the predictive models using all the records in the table because of the highly unbalanced default output(risk vs nonrisk), measure the performance thought the 10-fold cross validation method.\r\n4. **Build the models**: Start building the models with Boosted tree model (least interpreta, but tend to produce most accurate results); Then apply Logistic regression, more simplistic and easy to implement (build two with fullset and reducedset).\r\n5. **Select the model**: Compare the models performance by AUC (area under ROC curve), procesing time and interpretability, choose Logistic Regression Model(with reducedset) as the final model, and we can get the variable importance easily from the coefficients.\r\n6. **Calculate the cut-off rate** (for default risk): by using the ROC weighted \"closest.topleft\" best thresholds choosing strategy. Get weight by calculating Probability Cost Function.\r\n7. other thoughts: in the model building steps, I tried randomforest and neural network as well, however, my computer cannot handel with these two complex models. Therefore, there might other complex models can provide better AUC, but the Logistic Regression already get the similar AUC compared with boosted trees. which indicates the current model reasonably approximates the performance of the more complex methods.\r\n\r\n## Dataset\r\n45211 observations with 8 variables\r\n\r\n 1. age (numeric)\r\n 2. job : type of job (categorical: \"admin.\",\"unknown\",\"unemployed\",\"management\",\"housemaid\",\"entrepreneur\",\"student\",\"blue-collar\",\"self-employed\",\"retired\",\"technician\",\"services\") \r\n 3. marital : marital status (categorical: \"married\",\"divorced\",\"single\"; note: \"divorced\" means divorced or widowed)\r\n 4. education (categorical: \"unknown\",\"secondary\",\"primary\",\"tertiary\")\r\n 5. default: has credit in default? (binary: \"yes\",\"no\")\r\n 6. balance: average yearly balance, in euros (numeric) \r\n 7. housing: has housing loan? (binary: \"yes\",\"no\")\r\n 8. loan: has personal loan? (binary: \"yes\",\"no\")\r\n\r\n## Preprocess the Data\r\nchange the xlsx file to csv file to make the reading process much faster\r\n\r\n```r\r\nmydata <- read.csv(\"Jenn's test.csv\", header = TRUE)\r\n```\r\n\r\n### Dealing with NA values\r\n\r\n```r\r\nlibrary(caret)\r\n```\r\n\r\n```\r\n## Loading required package: lattice\r\n## Loading required package: ggplot2\r\n```\r\n\r\n```r\r\nnaTest <- apply(mydata, 2, function(x) sum(is.na(x)==TRUE))\r\nnaTest\r\n```\r\n\r\n```\r\n##       age       job   marital education   default   balance   housing \r\n##         0         0         0         0         0         0         0 \r\n##      loan \r\n##         0\r\n```\r\n*No missing values, cheers!*\r\n\r\n### Plotting Numeric Predictors Density\r\n![plot of chunk unnamed-chunk-3](./CreditRiskModel_files/figure-html/unnamed-chunk-31.png) ![plot of chunk unnamed-chunk-3](./CreditRiskModel_files/figure-html/unnamed-chunk-32.png) \r\n\r\n*Right skewness distribution.*\r\n\r\n### Transforming Skewed Predictors.\r\n\"BoxCox\" and Standardizing to make numeric variables more normalized distribution like, \"Centering\" and \"Scaling\" to improve the numerical stability of the calculations.\r\n\r\n\r\n```r\r\npreObj <- preProcess(mydata1[,-3], method = c(\"BoxCox\",\"center\", \"scale\"))\r\ntrainmydata <- predict(preObj, mydata1[,-3])\r\nmydata2 <- mydata\r\nmydata2$age <- trainmydata$age\r\nmydata2$balance <- trainmydata$balance\r\n```\r\n\r\n### Creating Dummy Variables\r\n\r\n```r\r\ndummies <- dummyVars(default~., data = mydata2)\r\nmydata3 <- predict(dummies, newdata = mydata2)\r\nmydata3 <- data.frame(mydata3)\r\nmydata3$default <- mydata2$default\r\n```\r\n\r\n### remove near-zero variables\r\nthe binary nature of many predictors resulted in many cases where the data are very sparse and unbalanced.These high degree of class imbalance indicates that many of the predictors could be classified as near-zero variance predictors, which can lead to computational issues in many of the models.\r\n\r\n```r\r\nnzv <- nearZeroVar(mydata3, saveMetrics=TRUE)\r\nnzv1 <- which(nzv$nzv==TRUE)\r\nmydata4 <- mydata3[,-(nzv1)]\r\nmydata4$default <- mydata3$default\r\n```\r\n- \"full set\" of predictors `mydata3` included all the variables regardless of their distribution. \r\n- \"reduced set\" `mydata4` was developed for models that are sensitive to sparse and unbalanced predictors\r\n\r\n### Dealing with collinearity problem\r\n\r\nVisualize the correlation plots\r\n\r\n![plot of chunk unnamed-chunk-7](./CreditRiskModel_files/figure-html/unnamed-chunk-71.png) ![plot of chunk unnamed-chunk-7](./CreditRiskModel_files/figure-html/unnamed-chunk-72.png) \r\n\r\na high-correlations filter was used on the predictors set to remove these highly redundant predictors from both datasets\r\n\r\n\r\n```r\r\nfullCovMat <- cov(mydata3[,-26])\r\nlibrary(subselect)\r\nfullResults <- trim.matrix(fullCovMat)\r\ndiscardName1 <- fullResults$names.discarded\r\ndiscardName1\r\n```\r\n\r\n```\r\n## [1] \"job.unknown\"       \"marital.divorced\"  \"education.unknown\"\r\n## [4] \"housing.yes\"       \"loan.yes\"\r\n```\r\n\r\n```r\r\nreducedCovMat <- cov(mydata4[,-19])\r\nreducedResults <- trim.matrix(reducedCovMat)\r\ndiscardName2 <- reducedResults$names.discarded\r\ndiscardName2\r\n```\r\n\r\n```\r\n## [1] \"marital.divorced\" \"housing.yes\"      \"loan.no\"\r\n```\r\n\r\n```r\r\nmydata3 <- mydata3[,-(fullResults$numbers.discarded)]\r\nmydata4 <- mydata4[,-(reducedResults$numbers.discarded)]\r\n```\r\n\r\n## Build Predictive Models\r\n- Start building the models that are the least interpretable and most flexible, they tend to have a high likelihood of producing the empirically optimum results. Here I choose to start with Boosted tree model.\r\n- Then I choose Logistic regression, which is a more simplistic technique for estimating a classification boundary. It has no tuning parameters and its prediction equation is simple and easy to implement using most software (build two with fullset and reducedset)\r\n- Then compare the models performance though AUC (area under ROC curve) and the procesing time to choose the final model\r\n\r\n![plot of chunk unnamed-chunk-9](./CreditRiskModel_files/figure-html/unnamed-chunk-9.png) \r\n\r\nthe barplot shows the unbalanced number of observations in credit risk vs non-credit risk people. Therefore, We will use all the observations to create our predictive model and measure the performance using cross validation resampling strategies. \r\n\r\nthe frequency of \"no\" is 0.982\r\n\r\n### Parallel processing \r\n\r\nUse doSNOW for doing parallel processing\r\n\r\n```r\r\nlibrary(doSNOW)\r\n```\r\n\r\n```\r\n## Loading required package: foreach\r\n## Loading required package: iterators\r\n## Loading required package: snow\r\n```\r\n\r\n```r\r\nregisterDoSNOW(makeCluster(2, type = \"SOCK\"))\r\n```\r\n\r\n### Set trainControl parameters\r\n\r\nWe will use 10-fold cross validation to evaluate the models and select to parameters(for some models)\r\n\r\n```r\r\nctrl <- trainControl(method=\"cv\", summaryFunction = twoClassSummary,classProbs=TRUE, savePredictions =TRUE)\r\n```\r\n\r\n### Model1:Boosted Tree Model\r\n\r\n```r\r\nlibrary(pROC)\r\n```\r\n\r\n```\r\n## Type 'citation(\"pROC\")' for a citation.\r\n## \r\n## Attaching package: 'pROC'\r\n## \r\n## The following objects are masked from 'package:stats':\r\n## \r\n##     cov, smooth, var\r\n```\r\n\r\n```r\r\nlibrary(gbm)\r\n```\r\n\r\n```\r\n## Loading required package: survival\r\n## Loading required package: splines\r\n## \r\n## Attaching package: 'survival'\r\n## \r\n## The following object is masked from 'package:caret':\r\n## \r\n##     cluster\r\n## \r\n## Loading required package: parallel\r\n## \r\n## Attaching package: 'parallel'\r\n## \r\n## The following objects are masked from 'package:snow':\r\n## \r\n##     clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,\r\n##     clusterExport, clusterMap, clusterSplit, makeCluster,\r\n##     parApply, parCapply, parLapply, parRapply, parSapply,\r\n##     splitIndices, stopCluster\r\n## \r\n## Loaded gbm 2.1\r\n```\r\n\r\n```r\r\nlibrary(plyr)\r\nset.seed(4321)\r\nt1 <- Sys.time()\r\nmod1 <- train(default~., data = mydata, method = \"gbm\",metric = \"ROC\",trControl = ctrl, verbose=FALSE)\r\nt2 <- Sys.time()\r\ntmod1 <- difftime(t2,t1)\r\nmod1\r\n```\r\n\r\n```\r\n## Stochastic Gradient Boosting \r\n## \r\n## 45211 samples\r\n##     7 predictor\r\n##     2 classes: 'no', 'yes' \r\n## \r\n## No pre-processing\r\n## Resampling: Cross-Validated (10 fold) \r\n## \r\n## Summary of sample sizes: 40689, 40690, 40691, 40690, 40690, 40691, ... \r\n## \r\n## Resampling results across tuning parameters:\r\n## \r\n##   interaction.depth  n.trees  ROC  Sens  Spec   ROC SD  Sens SD  Spec SD\r\n##   1                   50      0.9  1     0.000  0.02    1e-04    0.000  \r\n##   1                  100      0.9  1     0.001  0.02    2e-04    0.004  \r\n##   1                  150      0.9  1     0.002  0.02    2e-04    0.005  \r\n##   2                   50      0.9  1     0.002  0.02    2e-04    0.005  \r\n##   2                  100      0.9  1     0.010  0.02    2e-04    0.010  \r\n##   2                  150      0.9  1     0.012  0.02    2e-04    0.008  \r\n##   3                   50      0.9  1     0.006  0.02    2e-04    0.009  \r\n##   3                  100      0.9  1     0.012  0.02    2e-04    0.013  \r\n##   3                  150      0.9  1     0.016  0.02    3e-04    0.019  \r\n## \r\n## Tuning parameter 'shrinkage' was held constant at a value of 0.1\r\n## ROC was used to select the optimal model using  the largest value.\r\n## The final values used for the model were n.trees = 150,\r\n##  interaction.depth = 3 and shrinkage = 0.1.\r\n```\r\n\r\n```r\r\ntmod1\r\n```\r\n\r\n```\r\n## Time difference of 1.835 mins\r\n```\r\n\r\n### Model2: Logistic Regression with fullset\r\n\r\n```r\r\nset.seed(4321)\r\nt3 <- Sys.time()\r\nmod2 <- train(default~., data = mydata3, method = \"glm\", metric=\"ROC\",trControl = ctrl)\r\n```\r\n\r\n```\r\n## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\r\n```\r\n\r\n```r\r\nt4 <- Sys.time()\r\ntmod2 <- difftime(t4,t3)\r\nmod2\r\n```\r\n\r\n```\r\n## Generalized Linear Model \r\n## \r\n## 45211 samples\r\n##    20 predictor\r\n##     2 classes: 'no', 'yes' \r\n## \r\n## No pre-processing\r\n## Resampling: Cross-Validated (10 fold) \r\n## \r\n## Summary of sample sizes: 40689, 40690, 40691, 40690, 40690, 40691, ... \r\n## \r\n## Resampling results\r\n## \r\n##   ROC  Sens  Spec  ROC SD  Sens SD  Spec SD\r\n##   0.9  1     0.02  0.02    4e-04    0.02   \r\n## \r\n## \r\n```\r\n\r\n```r\r\ntmod2\r\n```\r\n\r\n```\r\n## Time difference of 24.63 secs\r\n```\r\n\r\n### Model3: Logistic Regression with reducedSet\r\n\r\n```r\r\nset.seed(4321)\r\nt5 <- Sys.time()\r\nmod3 <- train(default~., data = mydata4, method = \"glm\", metric=\"ROC\",trControl = ctrl)\r\n```\r\n\r\n```\r\n## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\r\n```\r\n\r\n```r\r\nt6 <- Sys.time()\r\ntmod3 <- difftime(t6,t5)\r\nmod3\r\n```\r\n\r\n```\r\n## Generalized Linear Model \r\n## \r\n## 45211 samples\r\n##    15 predictor\r\n##     2 classes: 'no', 'yes' \r\n## \r\n## No pre-processing\r\n## Resampling: Cross-Validated (10 fold) \r\n## \r\n## Summary of sample sizes: 40689, 40690, 40691, 40690, 40690, 40691, ... \r\n## \r\n## Resampling results\r\n## \r\n##   ROC  Sens  Spec  ROC SD  Sens SD  Spec SD\r\n##   0.9  1     0.02  0.02    4e-04    0.02   \r\n## \r\n## \r\n```\r\n\r\n```r\r\ntmod3\r\n```\r\n\r\n```\r\n## Time difference of 18.25 secs\r\n```\r\n\r\n\r\n## Measure and Select the Model\r\n\r\n### Measure the performance by AUC (ROC) and processing Time (with cross validation)\r\n\r\n- For this credit risk model, accuracy is not the primary goal, ROC curve can be used for a quantitative assesment of the model. The model with the largest area under ROC curve would be the most effective. \r\n- Because the severe Class imbalance exists, we can use ROC curve to choose a threshold that appropriately maximizes the trade-off between sensitivity and specificity or find the particular target points on the ROC curve. we can use the ROC curve to determine the alternate cutoffs for the class probabilities. \r\n- The performance is estimated through 10-fold cross validation\r\n\r\n\r\n```\r\n## \r\n## Call:\r\n## roc.default(response = mod1$pred$obs, predictor = mod1$pred$no,     levels = rev(levels(mod1$pred$obs)))\r\n## \r\n## Data: mod1$pred$no in 7335 controls (mod1$pred$obs yes) < 399564 cases (mod1$pred$obs no).\r\n## Area under the curve: 0.866\r\n```\r\n\r\n![plot of chunk unnamed-chunk-15](./CreditRiskModel_files/figure-html/unnamed-chunk-15.png) \r\n\r\n### Selecting Model\r\n- ROC plot shows the boosted tree model provide largest AUC, but just a little higher than the logistic regression model. However the processing time is around 6 times than the logistic regression model with reducedset. And Logistic Regression is much easier to interpret.\r\n- Two logistic regression models have no significant difference in AUC, so we choose the one with reducedset because of the less time required mod3. Below is our final model. We can get the variable importance from the coeffieienct.\r\n\r\n**Final Model**\r\n\r\n```\r\n## \r\n## Call:  NULL\r\n## \r\n## Coefficients:\r\n##         (Intercept)                  age           job.admin.  \r\n##             -6.1973              -0.1013              -0.6756  \r\n##     job.blue.collar       job.management          job.retired  \r\n##             -0.1975              -0.0742              -0.4470  \r\n##        job.services       job.technician      marital.married  \r\n##             -0.5252              -0.4750              -0.3710  \r\n##      marital.single    education.primary  education.secondary  \r\n##             -0.1810              -0.0866              -0.0519  \r\n##  education.tertiary              balance           housing.no  \r\n##             -0.4233              -6.8706               0.4316  \r\n##            loan.yes  \r\n##              0.7240  \r\n## \r\n## Degrees of Freedom: 45210 Total (i.e. Null);  45195 Residual\r\n## Null Deviance:\t    8160 \r\n## Residual Deviance: 6690 \tAIC: 6720\r\n```\r\n\r\n## Determine the profit-risk control cutoff rate.\r\n\r\nWe want to reduce the cost associate with the fraudulent transactions. Here, the event of interest is no fraud, The False Positive and False Negative results will cause a loss of money. True Positive results will bring the income.\r\n\r\nAssuming average requested loan for a person is $4000, and interest rate is 20%\r\nWe make the assumption that the cost are only calculated for the first year\r\n- False Positive Cost: $4000\r\n- False Negative Cost: $4000*.2\r\n\r\n### Calculate Probability Cost Function\r\npcf is the proportion of the total cost associated with a false-positive sample.\r\n\r\n```r\r\nfpc <- 4000\r\nfnc <- 4000*.2\r\npcf <- (freq*fpc)/((freq*fnc)+((1-freq)*fpc))\r\ncostWeight <- 1/pcf\r\n```\r\ncostWeight is the cost associated with the falso-negative sample\r\n\r\n### Get cutoff by using \"closest.topleft\" strategy\r\n\r\nAdjusting the Cost weights and get ROC cutoff\r\n\r\n```r\r\nlibrary(pROC)\r\n```\r\n\r\n```\r\n## Type 'citation(\"pROC\")' for a citation.\r\n## \r\n## Attaching package: 'pROC'\r\n## \r\n## The following objects are masked from 'package:stats':\r\n## \r\n##     cov, smooth, var\r\n```\r\n\r\n```r\r\ncutoff <- coords(mod3Roc, \"b\", ret=c(\"threshold\", \"specificity\", \"sensitivity\"), best.method=\"closest.topleft\", best.weights=c(costWeight, freq))\r\ncutoff\r\n```\r\n\r\n```\r\n##   threshold specificity sensitivity \r\n##      0.9593      0.5448      0.9135\r\n```\r\n\r\n```r\r\ncutoffRisk <- 1- cutoff[1]\r\ncutoffRisk\r\n```\r\n\r\n```\r\n## threshold \r\n##   0.04065\r\n```\r\n*Therefore, with this logistic regression model,  0.0407 is the suggesed default risk to provide decision support on profit-risk control.*\r\n\r\n## Predicte Result\r\nHere shows the top 10 lines of the new dataset with probability filled in. \r\n\r\n```r\r\nmydata5 <- predict(mod3, newdata = mydata4, type = \"prob\")\r\nmydata$risk <- mydata5$yes\r\nhead(mydata)\r\n```\r\n\r\n```\r\n##   age          job marital education default balance housing loan\r\n## 1  58   management married  tertiary      no    2143     yes   no\r\n## 2  44   technician  single secondary      no      29     yes   no\r\n## 3  33 entrepreneur married secondary      no       2     yes  yes\r\n## 4  47  blue-collar married   unknown      no    1506     yes   no\r\n## 5  33      unknown  single   unknown      no       1      no   no\r\n## 6  35   management married  tertiary      no     231     yes   no\r\n##        risk\r\n## 1 0.0001260\r\n## 2 0.0191078\r\n## 3 0.0598666\r\n## 4 0.0007779\r\n## 5 0.0572081\r\n## 6 0.0113884\r\n```\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}